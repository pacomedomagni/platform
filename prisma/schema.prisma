generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

enum StockConsumptionStrategy {
  FIFO
  FEFO
}

model Tenant {
  id                       String                   @id @default(uuid())
  name                     String
  businessName             String? // Display name for storefront
  email                    String? // Contact/support email
  domain                   String?                  @unique
  customDomain             String?                  @unique
  customDomainStatus       String                   @default("not_set") // "not_set"|"pending"|"verified"|"failed"
  customDomainVerifiedAt   DateTime?
  isActive                 Boolean                  @default(true)
  baseCurrency             String                   @default("USD")
  stockConsumptionStrategy StockConsumptionStrategy @default(FIFO)
  allowNegativeStock       Boolean                  @default(false)

  // Storefront configuration
  nextOrderNumber        Int     @default(1)
  defaultTaxRate         Decimal @default(0.0825) @db.Decimal(8, 6)
  defaultShippingRate    Decimal @default(9.99) @db.Decimal(18, 2)
  freeShippingThreshold  Decimal @default(100.00) @db.Decimal(18, 2)

  // Payment provider configuration
  paymentProvider         String?  // "stripe" | "square" | null
  paymentProviderStatus   String   @default("pending") // "pending"|"onboarding"|"active"|"disabled"

  // Stripe Connect
  stripeConnectAccountId  String?  @unique
  stripeChargesEnabled    Boolean  @default(false)
  stripePayoutsEnabled    Boolean  @default(false)
  stripeDetailsSubmitted  Boolean  @default(false)

  // Square
  squareMerchantId        String?  @unique
  squareLocationId        String?
  squareAccessToken       String?  // Encrypted
  squareRefreshToken      String?  // Encrypted
  squareAccessTokenExpiry DateTime?

  // Platform fees
  platformFeePercent      Decimal  @default(2.9) @db.Decimal(5, 2)
  platformFeeFixed        Decimal  @default(0.30) @db.Decimal(18, 2)

  // Onboarding tracking
  onboardingStep          String?  // "signup"|"provisioning"|"payment"|"completed"
  onboardingCompletedAt   DateTime?

  // Storefront publish gate
  storePublished    Boolean   @default(false)
  storePublishedAt  DateTime?

  createdAt                DateTime                 @default(now())
  updatedAt                DateTime                 @updatedAt

  users                     User[]
  warehouses                Warehouse[]
  locations                 Location[]
  items                     Item[]
  itemUoms                  ItemUom[]
  batches                   Batch[]
  serials                   Serial[]
  warehouseItemBalances     WarehouseItemBalance[]
  binBalances               BinBalance[]
  stockFifoLayers           StockFifoLayer[]
  stockPostings             StockPosting[]
  stockLedgerEntries        StockLedgerEntry[]
  stockLedgerEntrySerials   StockLedgerEntrySerial[]
  accounts                  Account[]
  glEntries                 GlEntry[]
  auditLogs                 AuditLog[]
  customers                 Customer[]
  suppliers                 Supplier[]
  addresses                 Address[]
  contacts                  Contact[]
  contactLinks              ContactLink[]
  banks                     Bank[]
  bankAccounts              BankAccount[]
  bankTransactions          BankTransaction[]
  bankReconciliations       BankReconciliation[]
  bankReconciliationDetails BankReconciliationDetail[]
  bankMatchingRules         BankMatchingRule[]

  // Storefront relations
  productCategories       ProductCategory[]
  productListings         ProductListing[]
  storeCustomers          StoreCustomer[]
  storeAddresses          StoreAddress[]
  passwordResets          PasswordReset[]
  emailVerificationTokens EmailVerificationToken[]
  carts                   Cart[]
  cartItems               CartItem[]
  orders                  Order[]
  orderItems              OrderItem[]
  payments                Payment[]
  coupons                 Coupon[]
  couponUsages            CouponUsage[]

  // Phase 2 E-commerce
  itemAttributeTypes   ItemAttributeType[]
  itemAttributeValues  ItemAttributeValue[]
  productVariants      ProductVariant[]
  productReviews       ProductReview[]
  giftCards            GiftCard[]
  giftCardTransactions GiftCardTransaction[]
  wishlists            Wishlist[]

  // Email compliance
  storeCustomerPreferences StoreCustomerPreferences[]
  emailBounces             EmailBounce[]

  // Theme system
  storeThemes StoreTheme[]

  // Marketplace integrations
  marketplaceConnections     MarketplaceConnection[]
  marketplaceListings        MarketplaceListing[]
  marketplaceOrders          MarketplaceOrder[]
  marketplaceActiveListings  MarketplaceActiveListing[]
  marketplaceSyncLogs        MarketplaceSyncLog[]
  failedOperations           FailedOperation[]

  // Webhook system (database-backed)
  webhooks Webhook[]

  // OAuth state management
  oauthStates OAuthState[]

  // Store pages (legal, custom)
  storePages StorePage[]

  // Product import jobs
  productImportJobs ProductImportJob[]

  // Branch 12: Digital, Analytics, Reports, Page Builder
  pageSections     PageSection[]
  digitalDownloads DigitalDownload[]
  funnelEvents     FunnelEvent[]
  scheduledReports ScheduledReport[]

  @@map("tenants")
}

model User {
  id        String  @id @default(uuid())
  email     String  @unique
  password  String  @default("") // Managed by Auth Provider usually, but here for completeness
  firstName String?
  lastName  String?

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  roles String[] @default(["user"])

  // Email verification
  emailVerified   Boolean   @default(false)
  emailVerifiedAt DateTime?
  emailVerificationTokens MerchantEmailVerificationToken[]

  // Marketplace listing approvals
  approvedMarketplaceListings MarketplaceListing[] @relation("MarketplaceListingApprover")
  rejectedMarketplaceListings MarketplaceListing[] @relation("MarketplaceListingRejecter")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Index for performance
  @@index([tenantId])
  @@map("users")
}

model Currency {
  code      String   @id // ISO 4217, e.g. "USD"
  name      String
  symbol    String?
  decimals  Int      @default(2)
  isEnabled Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("currencies")
}

model ExchangeRate {
  id        String   @id @default(uuid())
  fromCode  String
  toCode    String
  rate      Decimal  @db.Decimal(18, 9)
  rateDate  DateTime @db.Date
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fromCode, toCode, rateDate])
  @@index([toCode, rateDate])
  @@map("exchange_rates")
}

model DocType {
  id          String  @id @default(uuid())
  name        String  @unique // Internal ID name, e.g. "Sales Order"
  module      String // e.g. "Selling"
  isSingle    Boolean @default(false)
  isChild     Boolean @default(false)
  description String?

  fields DocField[]
  perms  DocPerm[]

  // For storing the table name if it differs, though usually derived from name
  tableName String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("doc_types")
}

model DocField {
  id String @id @default(uuid())

  docTypeName String
  docType     DocType @relation(fields: [docTypeName], references: [name], onDelete: Cascade)

  name  String // e.g. "customer"
  label String // e.g. "Customer"
  type  String // Data, Link, Int, etc.

  required Boolean @default(false)
  unique   Boolean @default(false)
  hidden   Boolean @default(false)
  readonly Boolean @default(false)

  options String? // For Select
  target  String? // For Link (related DocType name)

  idx Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([docTypeName])
  @@map("doc_fields")
}

model DocPerm {
  id String @id @default(uuid())

  docTypeName String
  docType     DocType @relation(fields: [docTypeName], references: [name], onDelete: Cascade)

  role String // e.g. "System Manager", "Sales User"

  read   Boolean @default(true)
  write  Boolean @default(false)
  create Boolean @default(false)
  delete Boolean @default(false)
  submit Boolean @default(false)
  cancel Boolean @default(false)
  amend  Boolean @default(false)
  report Boolean @default(false)

  idx Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([docTypeName])
  @@index([role])
  @@map("doc_perms")
}

model Warehouse {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  code     String
  name     String
  isActive Boolean @default(true)

  // Optional defaults for operational flows
  defaultReceivingLocationId String?
  defaultPickingLocationId   String?

  locations Location[]

  deletedAt             DateTime?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  warehouseItemBalances WarehouseItemBalance[]
  binBalances           BinBalance[]
  stockFifoLayers       StockFifoLayer[]
  stockLedgerEntries    StockLedgerEntry[]
  serials               Serial[]
  marketplaceListings   MarketplaceListing[]

  @@unique([tenantId, code])
  @@unique([tenantId, name])
  @@map("warehouses")
}

model Location {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  parentId String?
  parent   Location?  @relation("LocationTree", fields: [parentId], references: [id], onDelete: SetNull)
  children Location[] @relation("LocationTree")

  code String
  name String?
  path String // e.g. "WH1/A1/BIN-01"

  isPickable Boolean @default(true)
  isPutaway  Boolean @default(true)
  isStaging  Boolean @default(false)
  isActive   Boolean @default(true)

  deletedAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stockFromEntries StockLedgerEntry[] @relation("StockFromLocation")
  stockToEntries   StockLedgerEntry[] @relation("StockToLocation")
  binBalances      BinBalance[]
  stockFifoLayers  StockFifoLayer[]
  serials          Serial[]

  @@unique([tenantId, warehouseId, code])
  @@unique([tenantId, warehouseId, path])
  @@index([warehouseId])
  @@map("locations")
}

model Item {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  code        String
  name        String
  isStockItem Boolean @default(true)
  isActive    Boolean @default(true)

  hasBatch     Boolean  @default(false)
  hasSerial    Boolean  @default(false)
  reorderLevel Decimal? @db.Decimal(18, 6)
  reorderQty   Decimal? @db.Decimal(18, 6)

  incomeAccount  String?
  expenseAccount String?
  stockAccount   String?
  cogsAccount    String?

  stockUomCode    String?
  stockUom        Uom?    @relation("ItemStockUom", fields: [stockUomCode], references: [code], onDelete: SetNull)
  purchaseUomCode String?
  purchaseUom     Uom?    @relation("ItemPurchaseUom", fields: [purchaseUomCode], references: [code], onDelete: SetNull)
  salesUomCode    String?
  salesUom        Uom?    @relation("ItemSalesUom", fields: [salesUomCode], references: [code], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  batches               Batch[]
  serials               Serial[]
  itemUoms              ItemUom[]
  warehouseItemBalances WarehouseItemBalance[]
  binBalances           BinBalance[]
  stockFifoLayers       StockFifoLayer[]
  stockLedgerEntries    StockLedgerEntry[]
  productListing        ProductListing?
  productVariants       ProductVariant[]

  @@unique([tenantId, code])
  @@map("items")
}

model Uom {
  code     String  @id
  name     String?
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  itemsStock    Item[]    @relation("ItemStockUom")
  itemsPurchase Item[]    @relation("ItemPurchaseUom")
  itemsSales    Item[]    @relation("ItemSalesUom")
  itemUoms      ItemUom[]

  @@map("uoms")
}

model ItemUom {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  itemId String
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Cascade)

  uomCode String
  uom     Uom    @relation(fields: [uomCode], references: [code], onDelete: Cascade)

  conversionFactor Decimal @db.Decimal(18, 6)
  isActive         Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, itemId, uomCode])
  @@index([itemId])
  @@map("item_uoms")
}

enum SerialStatus {
  AVAILABLE
  ISSUED
}

model Serial {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  itemId String
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Cascade)

  serialNo String
  status   SerialStatus @default(AVAILABLE)

  warehouseId String?
  warehouse   Warehouse? @relation(fields: [warehouseId], references: [id], onDelete: SetNull)

  locationId String?
  location   Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)

  batchId String?
  batch   Batch?  @relation(fields: [batchId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ledgerEntries StockLedgerEntrySerial[]

  @@unique([tenantId, serialNo])
  @@index([itemId])
  @@index([warehouseId])
  @@map("serials")
}

model Batch {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  itemId String
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Cascade)

  batchNo  String
  mfgDate  DateTime? @db.Date
  expDate  DateTime? @db.Date
  isActive Boolean   @default(true)

  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  binBalances        BinBalance[]
  stockFifoLayers    StockFifoLayer[]
  stockLedgerEntries StockLedgerEntry[]
  serials            Serial[]

  @@unique([tenantId, itemId, batchNo])
  @@index([itemId])
  @@map("batches")
}

model WarehouseItemBalance {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  itemId String
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Cascade)

  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  actualQty   Decimal @default(0) @db.Decimal(18, 6)
  reservedQty Decimal @default(0) @db.Decimal(18, 6)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, itemId, warehouseId])
  @@index([warehouseId])
  @@map("warehouse_item_balances")
}

model BinBalance {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  itemId String
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Cascade)

  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  locationId String
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  batchId String?
  batch   Batch?  @relation(fields: [batchId], references: [id], onDelete: SetNull)

  actualQty   Decimal @default(0) @db.Decimal(18, 6)
  reservedQty Decimal @default(0) @db.Decimal(18, 6)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, itemId, warehouseId, locationId, batchId])
  @@index([locationId])
  @@map("bin_balances")
}

model StockFifoLayer {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  itemId String
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Cascade)

  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  locationId String
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  batchId String?
  batch   Batch?  @relation(fields: [batchId], references: [id], onDelete: SetNull)

  postingTs    DateTime
  qtyOriginal  Decimal  @db.Decimal(18, 6)
  qtyRemaining Decimal  @db.Decimal(18, 6)
  incomingRate Decimal  @db.Decimal(18, 6)
  isCancelled  Boolean  @default(false)

  // For derived layers (e.g. stock transfer), keep lineage to support safe reversals.
  sourceLayerId String?
  sourceLayer   StockFifoLayer?  @relation("LayerSource", fields: [sourceLayerId], references: [id], onDelete: SetNull)
  derivedLayers StockFifoLayer[] @relation("LayerSource")

  voucherType String
  voucherNo   String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stockLedgerEntries StockLedgerEntry[]

  @@index([tenantId, itemId, warehouseId, postingTs])
  @@index([batchId])
  @@index([sourceLayerId])
  @@map("stock_fifo_layers")
}

model StockPosting {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  postingKey  String
  voucherType String
  voucherNo   String

  createdAt DateTime @default(now())

  @@unique([tenantId, postingKey])
  @@index([tenantId, voucherType, voucherNo])
  @@map("stock_postings")
}

model AuditLog {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId  String?
  action  String
  docType String
  docName String
  meta    Json?

  createdAt DateTime @default(now())

  @@index([tenantId, docType])
  @@index([docName])
  @@map("audit_logs")
}

model StockLedgerEntry {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  postingTs   DateTime
  postingDate DateTime @db.Date

  itemId String
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Cascade)

  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  fromLocationId String?
  fromLocation   Location? @relation("StockFromLocation", fields: [fromLocationId], references: [id], onDelete: SetNull)
  toLocationId   String?
  toLocation     Location? @relation("StockToLocation", fields: [toLocationId], references: [id], onDelete: SetNull)

  batchId String?
  batch   Batch?  @relation(fields: [batchId], references: [id], onDelete: SetNull)

  fifoLayerId String?
  fifoLayer   StockFifoLayer? @relation(fields: [fifoLayerId], references: [id], onDelete: SetNull)

  qty                  Decimal @db.Decimal(18, 6)
  valuationRate        Decimal @db.Decimal(18, 6)
  stockValueDifference Decimal @db.Decimal(18, 6)

  voucherType String
  voucherNo   String

  createdAt DateTime @default(now())

  serials StockLedgerEntrySerial[]

  @@index([tenantId, postingDate])
  @@index([tenantId, itemId, warehouseId])
  @@index([tenantId, voucherType, voucherNo])
  @@map("stock_ledger_entries")
}

model StockLedgerEntrySerial {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  ledgerEntryId String
  ledgerEntry   StockLedgerEntry @relation(fields: [ledgerEntryId], references: [id], onDelete: Cascade)

  serialId String
  serial   Serial @relation(fields: [serialId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([ledgerEntryId])
  @@index([serialId])
  @@map("stock_ledger_entry_serials")
}

model Account {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  code              String
  name              String
  rootType          String?
  accountType       String?
  isGroup           Boolean @default(false)
  parentAccountCode String?
  currency          String? // null means tenant base currency
  isActive          Boolean @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  glEntries GlEntry[]

  @@unique([tenantId, code])
  @@map("accounts")
}

model GlEntry {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  postingDate DateTime @db.Date
  postingTs   DateTime

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  currency     String
  exchangeRate Decimal @db.Decimal(18, 9)

  debitBc  Decimal @default(0) @db.Decimal(18, 6)
  creditBc Decimal @default(0) @db.Decimal(18, 6)
  debitFc  Decimal @default(0) @db.Decimal(18, 6)
  creditFc Decimal @default(0) @db.Decimal(18, 6)

  voucherType String
  voucherNo   String
  remarks     String?

  createdAt DateTime @default(now())

  @@index([tenantId, postingDate])
  @@index([tenantId, voucherType, voucherNo])
  @@map("gl_entries")
}

// ==================== PARTY MASTERS ====================

model Customer {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  code          String
  customerName  String
  customerType  String  @default("Company")
  customerGroup String?
  territory     String?

  taxId       String?
  taxCategory String?

  defaultCurrency     String?
  defaultPriceList    String?
  defaultPaymentTerms String?

  creditLimit Decimal @default(0) @db.Decimal(18, 6)
  creditDays  Int     @default(0)

  receivableAccount String?

  primaryAddress String?
  primaryContact String?

  isActive Boolean @default(true)
  isFrozen Boolean @default(false)

  website String?
  notes   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  storeCustomers StoreCustomer[]

  @@unique([tenantId, code])
  @@index([tenantId, customerName])
  @@index([tenantId, customerGroup])
  @@map("customers")
}

model Supplier {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  code          String
  supplierName  String
  supplierType  String  @default("Company")
  supplierGroup String?
  country       String?

  taxId                  String?
  taxCategory            String?
  taxWithholdingCategory String?

  defaultCurrency     String?
  defaultPriceList    String?
  defaultPaymentTerms String?

  paymentDays Int @default(0)

  payableAccount String?
  expenseAccount String?

  primaryAddress String?
  primaryContact String?

  isActive Boolean @default(true)
  isFrozen Boolean @default(false)

  website String?
  notes   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, code])
  @@index([tenantId, supplierName])
  @@index([tenantId, supplierGroup])
  @@map("suppliers")
}

model Address {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  linkDoctype String
  linkName    String

  addressType  String  @default("Billing")
  addressTitle String?
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  country      String  @default("United States")
  postalCode   String?

  phone String?
  fax   String?
  email String?

  isPrimaryAddress  Boolean @default(false)
  isShippingAddress Boolean @default(false)
  isActive          Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, linkDoctype, linkName])
  @@map("addresses")
}

model Contact {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String
  firstName   String?
  lastName    String?
  fullName    String?
  salutation  String?
  designation String?

  email  String?
  phone  String?
  mobile String?

  isPrimaryContact Boolean @default(false)
  isBillingContact Boolean @default(false)
  isActive         Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  links ContactLink[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("contacts")
}

model ContactLink {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  contactId String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  linkDoctype String
  linkName    String

  createdAt DateTime @default(now())

  @@unique([tenantId, contactId, linkDoctype, linkName])
  @@index([contactId])
  @@index([tenantId, linkDoctype, linkName])
  @@map("contact_links")
}

// ==================== BANKING ====================

model Bank {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  code     String
  bankName String

  website   String?
  swiftCode String?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, code])
  @@index([tenantId])
  @@map("banks")
}

model BankAccount {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name String

  bankCode      String?
  accountNumber String?
  accountType   String  @default("Current")
  iban          String?
  branchCode    String?

  glAccount String?
  currency  String  @default("USD")

  bankBalance  Decimal   @default(0) @db.Decimal(18, 6)
  lastSyncDate DateTime? @db.Date

  integrationId String?

  isDefault Boolean @default(false)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([tenantId, glAccount])
  @@map("bank_accounts")
}

model BankTransaction {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name String

  bankAccount     String
  transactionDate DateTime @db.Date
  amount          Decimal  @db.Decimal(18, 6)
  currency        String   @default("USD")
  transactionType String

  description     String?
  referenceNumber String?

  partyType String?
  party     String?

  status String @default("Unreconciled")

  paymentEntry String?
  invoice      String?

  reconciliationId String?

  importBatch String?
  externalId  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([tenantId, bankAccount])
  @@index([tenantId, transactionDate])
  @@index([tenantId, status])
  @@index([tenantId, externalId])
  @@map("bank_transactions")
}

model BankReconciliation {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name String

  bankAccount String

  fromDate DateTime @db.Date
  toDate   DateTime @db.Date

  openingBalance       Decimal @default(0) @db.Decimal(18, 6)
  closingBalance       Decimal @default(0) @db.Decimal(18, 6)
  bankStatementBalance Decimal @default(0) @db.Decimal(18, 6)

  difference Decimal @default(0) @db.Decimal(18, 6)

  docstatus Int    @default(0)
  status    String @default("Draft")

  notes String?
  owner String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  details BankReconciliationDetail[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([tenantId, bankAccount])
  @@map("bank_reconciliations")
}

model BankReconciliationDetail {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  parentId String
  parent   BankReconciliation @relation(fields: [parentId], references: [id], onDelete: Cascade)

  bankTransaction String?
  glEntryId       String?

  voucherType String?
  voucherNo   String?

  amount      Decimal   @db.Decimal(18, 6)
  postingDate DateTime? @db.Date

  isMatched     Boolean   @default(false)
  clearanceDate DateTime? @db.Date

  createdAt DateTime @default(now())

  @@index([parentId])
  @@index([tenantId])
  @@map("bank_reconciliation_details")
}

model BankMatchingRule {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name String

  bankAccount         String?
  descriptionContains String?
  descriptionRegex    String?
  amountMin           Decimal? @db.Decimal(18, 6)
  amountMax           Decimal? @db.Decimal(18, 6)
  transactionType     String?

  action    String  @default("Create Payment Entry")
  partyType String?
  party     String?
  account   String?

  priority Int @default(0)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("bank_matching_rules")
}

// ==================== STOREFRONT ====================

model ProductCategory {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String
  slug        String
  description String?
  imageUrl    String?

  parentId String?
  parent   ProductCategory?  @relation("CategoryTree", fields: [parentId], references: [id], onDelete: SetNull)
  children ProductCategory[] @relation("CategoryTree")

  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products     ProductListing[]
  translations CategoryTranslation[]

  @@unique([tenantId, slug])
  @@index([tenantId, isActive])
  @@map("product_categories")
}

model ProductListing {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  itemId String @unique
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Cascade)

  categoryId String?
  category   ProductCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  slug             String
  displayName      String
  shortDescription String?
  longDescription  String?

  price          Decimal  @db.Decimal(18, 2)
  compareAtPrice Decimal? @db.Decimal(18, 2)
  costPrice      Decimal? @db.Decimal(18, 2)

  images String[] // Array of image URLs
  badge  String? // "Best Seller", "New Arrival", "Limited", etc.

  metaTitle       String?
  metaDescription String?

  isFeatured  Boolean   @default(false)
  isPublished Boolean   @default(false)
  publishedAt DateTime?

  sortOrder Int @default(0)

  // Digital product fields
  isDigital       Boolean @default(false)
  digitalFileKey  String? // S3 key or file reference
  downloadLimit   Int?    // Max download count per purchase
  downloadExpiry  Int?    // Expiry in days after purchase

  // Review stats (cached for performance)
  averageRating Decimal? @default(0) @db.Decimal(3, 2)
  reviewCount   Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cartItems      CartItem[]
  orderItems     OrderItem[]
  variants       ProductVariant[]
  reviews        ProductReview[]
  wishlistItems  WishlistItem[]
  priceOverrides ProductPriceOverride[]
  translations   ProductTranslation[]
  marketplaceListings MarketplaceListing[]
  digitalDownloads    DigitalDownload[]

  @@unique([tenantId, slug])
  @@unique([tenantId, itemId])
  @@index([tenantId, isPublished])
  @@index([tenantId, categoryId])
  @@index([tenantId, isFeatured])
  @@map("product_listings")
}

// Storefront Customer (separate from B2B Customer)
model StoreCustomer {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  email        String
  passwordHash String?
  firstName    String?
  lastName     String?
  phone        String?

  // Link to B2B customer record if applicable
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  // Email verification
  emailVerified   Boolean   @default(false)
  emailVerifiedAt DateTime?

  // Password reset
  resetToken    String?
  resetTokenExp DateTime?

  // Marketing preferences
  acceptsMarketing Boolean @default(false)

  // Onboarding tracking
  onboardingCompleted       Boolean   @default(false)
  onboardingStep            String? // Current step: welcome, profile, tour, incentive, completed
  profileCompletionScore    Int       @default(0) // 0-100
  lastOnboardingInteraction DateTime?
  hasViewedProductTour      Boolean   @default(false)
  hasAddedToCart            Boolean   @default(false)
  hasCompletedFirstPurchase Boolean   @default(false)
  hasAddedShippingAddress   Boolean   @default(false)

  lastLoginAt  DateTime?
  isActive     Boolean   @default(true)
  tokenVersion Int       @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  carts                   Cart[]
  orders                  Order[]
  addresses               StoreAddress[]
  passwordResets          PasswordReset[]
  emailVerificationTokens EmailVerificationToken[]
  reviews                 ProductReview[]
  wishlists               Wishlist[]
  emailPreferences        StoreCustomerPreferences?
  couponUsages            CouponUsage[]

  @@unique([tenantId, email])
  @@index([tenantId, isActive])
  @@map("store_customers")
}

model StoreAddress {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  customerId String
  customer   StoreCustomer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  label        String  @default("Home")
  firstName    String?
  lastName     String?
  company      String?
  addressLine1 String
  addressLine2 String?
  city         String
  state        String?
  postalCode   String
  country      String  @default("US")
  phone        String?

  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@map("store_addresses")
}

model PasswordReset {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  customerId String
  customer   StoreCustomer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?

  createdAt DateTime @default(now())

  @@index([customerId])
  @@index([token])
  @@map("password_resets")
}

model EmailVerificationToken {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  customerId String
  customer   StoreCustomer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([customerId])
  @@index([token])
  @@map("email_verification_tokens")
}

model Cart {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Can be anonymous (no customer) or linked to customer
  customerId String?
  customer   StoreCustomer? @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Anonymous cart token
  sessionToken String? @unique

  // Cart status
  status String @default("active") // active, converted, abandoned

  // Shipping address (snapshot at checkout)
  shippingAddressId String?

  // Coupon/discount
  couponCode     String?
  discountAmount Decimal @default(0) @db.Decimal(18, 2)

  // Calculated totals (updated on cart changes)
  subtotal      Decimal @default(0) @db.Decimal(18, 2)
  shippingTotal Decimal @default(0) @db.Decimal(18, 2)
  taxTotal      Decimal @default(0) @db.Decimal(18, 2)
  grandTotal    Decimal @default(0) @db.Decimal(18, 2)

  // Cart recovery
  abandonedAt    DateTime?
  recoveredAt    DateTime?
  lastActivityAt DateTime  @default(now())

  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items CartItem[]
  order Order?

  @@index([tenantId, customerId])
  @@index([tenantId, sessionToken])
  @@index([tenantId, status])
  @@map("carts")
}

model CartItem {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  cartId String
  cart   Cart   @relation(fields: [cartId], references: [id], onDelete: Cascade)

  productId String
  product   ProductListing @relation(fields: [productId], references: [id], onDelete: Cascade)

  // Optional variant
  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  quantity Int     @default(1)
  price    Decimal @db.Decimal(18, 2) // Price at time of adding to cart

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cartId, productId, variantId])
  @@index([cartId])
  @@map("cart_items")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

model Order {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  orderNumber String

  customerId String?
  customer   StoreCustomer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  // Link to original cart
  cartId String? @unique
  cart   Cart?   @relation(fields: [cartId], references: [id], onDelete: SetNull)

  // Contact info (may differ from customer)
  email String
  phone String?

  // Billing address (snapshot)
  billingFirstName    String?
  billingLastName     String?
  billingCompany      String?
  billingAddressLine1 String?
  billingAddressLine2 String?
  billingCity         String?
  billingState        String?
  billingPostalCode   String?
  billingCountry      String?

  // Shipping address (snapshot)
  shippingFirstName    String?
  shippingLastName     String?
  shippingCompany      String?
  shippingAddressLine1 String?
  shippingAddressLine2 String?
  shippingCity         String?
  shippingState        String?
  shippingPostalCode   String?
  shippingCountry      String?

  // Order totals
  subtotal         Decimal @db.Decimal(18, 2)
  shippingTotal    Decimal @db.Decimal(18, 2)
  taxTotal         Decimal @db.Decimal(18, 2)
  discountTotal    Decimal @default(0) @db.Decimal(18, 2)
  giftCardDiscount Decimal @default(0) @db.Decimal(18, 2)
  grandTotal       Decimal @db.Decimal(18, 2)

  currency String @default("USD")

  // Status tracking
  status        OrderStatus   @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)

  // Stripe integration
  stripePaymentIntentId String?
  stripeChargeId        String?

  // Shipping tracking
  shippingMethod  String?
  shippingCarrier String?
  trackingNumber  String?
  shippedAt       DateTime?
  deliveredAt     DateTime?

  // Notes
  customerNotes String?
  internalNotes String?

  // Timestamps
  confirmedAt DateTime?
  cancelledAt DateTime?
  refundedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items              OrderItem[]
  payments           Payment[]
  giftCardsUsed      GiftCardTransaction[]
  couponUsage        CouponUsage?
  giftCardsGenerated GiftCard[]            @relation("GiftCardSource")
  shipments          Shipment[]
  marketplaceOrder   MarketplaceOrder?
  digitalDownloads   DigitalDownload[]

  @@unique([tenantId, orderNumber])
  @@index([tenantId, customerId])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@index([stripePaymentIntentId])
  @@map("orders")
}

model OrderItem {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String?
  product   ProductListing? @relation(fields: [productId], references: [id], onDelete: SetNull)

  // Optional variant
  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  // Snapshot of variant attributes at time of order
  variantAttributes Json?

  // Snapshot of product at time of order
  sku         String?
  name        String
  description String?
  imageUrl    String?

  quantity   Int
  unitPrice  Decimal @db.Decimal(18, 2)
  totalPrice Decimal @db.Decimal(18, 2)

  // Fulfillment tracking
  quantityFulfilled Int @default(0)
  quantityRefunded  Int @default(0)

  createdAt DateTime @default(now())

  @@index([orderId])
  @@map("order_items")
}

model Payment {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Payment details
  amount   Decimal @db.Decimal(18, 2)
  currency String  @default("USD")
  method   String  @default("card") // card, paypal, bank_transfer, gift_card, etc.

  // Status
  status PaymentStatus @default(PENDING)

  // Stripe references
  stripePaymentIntentId String?
  stripeChargeId        String?
  stripeRefundId        String?

  // Gift card payment
  giftCardId String?
  giftCard   GiftCard? @relation(fields: [giftCardId], references: [id], onDelete: SetNull)

  // Card details (last 4 digits only for display)
  cardBrand  String?
  cardLast4  String?
  cardExpiry String?

  // Error tracking
  errorCode    String?
  errorMessage String?

  // Timestamps
  authorizedAt DateTime?
  capturedAt   DateTime?
  failedAt     DateTime?
  refundedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([stripePaymentIntentId])
  @@index([giftCardId])
  @@map("payments")
}

// Coupon/discount codes
model Coupon {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  code        String
  description String?

  // Discount type
  discountType  String  @default("percentage") // percentage, fixed_amount
  discountValue Decimal @db.Decimal(18, 2)

  // Constraints
  minimumOrderAmount Decimal? @db.Decimal(18, 2)
  maximumDiscount    Decimal? @db.Decimal(18, 2)

  // Usage limits
  usageLimit            Int? // Total times this coupon can be used
  usageLimitPerCustomer Int? @default(1)
  timesUsed             Int  @default(0)

  // Validity
  startsAt  DateTime?
  expiresAt DateTime?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  usages CouponUsage[]

  @@unique([tenantId, code])
  @@index([tenantId, isActive])
  @@map("coupons")
}

// Coupon usage tracking
model CouponUsage {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  couponId String
  coupon   Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)

  customerId String?
  customer   StoreCustomer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  orderId String @unique
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  usedAt DateTime @default(now())

  @@unique([tenantId, couponId, customerId, orderId])
  @@index([tenantId, couponId])
  @@index([tenantId, customerId])
  @@map("coupon_usages")
}

// ==================== PHASE 2: E-COMMERCE ENHANCEMENTS ====================

// Attribute Types (e.g., "Color", "Size", "Material")
model ItemAttributeType {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String // Internal name (e.g., "color")
  displayName String // Display name (e.g., "Color")
  sortOrder   Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  values            ItemAttributeValue[]
  variantAttributes ProductVariantAttribute[]
  translations      AttributeTranslation[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("item_attribute_types")
}

// Attribute Values (e.g., "Red", "Blue", "Small", "Large")
model ItemAttributeValue {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  attributeTypeId String
  attributeType   ItemAttributeType @relation(fields: [attributeTypeId], references: [id], onDelete: Cascade)

  value        String // Internal value
  displayValue String // Display value
  colorHex     String? // For color swatches (e.g., "#FF0000")
  sortOrder    Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  variantAttributes ProductVariantAttribute[]
  translations      AttributeTranslation[]

  @@unique([attributeTypeId, value])
  @@index([tenantId])
  @@index([attributeTypeId])
  @@map("item_attribute_values")
}

// Product Variant (specific combination like "Red, Large")
model ProductVariant {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  productListingId String
  productListing   ProductListing @relation(fields: [productListingId], references: [id], onDelete: Cascade)

  // Variant-specific fields
  sku            String?
  barcode        String?
  price          Decimal? @db.Decimal(18, 2) // NULL means use parent price
  compareAtPrice Decimal? @db.Decimal(18, 2)
  costPrice      Decimal? @db.Decimal(18, 2)

  // Optional link to inventory Item for variant-level stock
  itemId String?
  item   Item?   @relation(fields: [itemId], references: [id], onDelete: SetNull)

  // Variant image
  imageUrl String?

  // Stock tracking at variant level
  stockQty       Int     @default(0)
  trackInventory Boolean @default(true)
  allowBackorder Boolean @default(false)

  // Shipping dimensions
  weight     Decimal? @db.Decimal(18, 4)
  weightUnit String   @default("kg")

  // Status
  isActive  Boolean @default(true)
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  attributes     ProductVariantAttribute[]
  cartItems      CartItem[]
  orderItems     OrderItem[]
  wishlistItems  WishlistItem[]
  priceOverrides VariantPriceOverride[]

  @@index([tenantId])
  @@index([productListingId])
  @@map("product_variants")
}

// Product Variant Attributes (junction table)
model ProductVariantAttribute {
  id String @id @default(uuid())

  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  attributeTypeId String
  attributeType   ItemAttributeType @relation(fields: [attributeTypeId], references: [id], onDelete: Cascade)

  attributeValueId String
  attributeValue   ItemAttributeValue @relation(fields: [attributeValueId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([variantId, attributeTypeId])
  @@index([variantId])
  @@map("product_variant_attributes")
}

// Product Reviews & Ratings
model ProductReview {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  productListingId String
  productListing   ProductListing @relation(fields: [productListingId], references: [id], onDelete: Cascade)

  customerId String?
  customer   StoreCustomer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  // Review content
  rating  Int // 1-5
  title   String?
  content String?
  pros    String?
  cons    String?

  // Reviewer info (for display)
  reviewerName       String?
  reviewerEmail      String?
  isVerifiedPurchase Boolean @default(false)

  // Review images
  images String[] // Array of image URLs

  // Moderation
  status          String    @default("pending") // pending, approved, rejected
  moderatedAt     DateTime?
  moderatedBy     String?
  moderationNotes String?

  // Helpfulness voting
  helpfulCount    Int @default(0)
  notHelpfulCount Int @default(0)

  // Admin response
  adminResponse    String?
  adminRespondedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  votes ReviewVote[]

  @@index([tenantId])
  @@index([productListingId])
  @@index([customerId])
  @@index([tenantId, status])
  @@map("product_reviews")
}

// Review helpfulness votes
model ReviewVote {
  id String @id @default(uuid())

  reviewId String
  review   ProductReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  customerId   String?
  sessionToken String? // For anonymous votes

  isHelpful Boolean

  createdAt DateTime @default(now())

  @@unique([reviewId, customerId])
  @@index([reviewId])
  @@map("review_votes")
}

// Gift Cards
model GiftCard {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Card details
  code String
  pin  String? // Optional PIN for security

  // Value
  initialValue   Decimal @db.Decimal(18, 2)
  currentBalance Decimal @db.Decimal(18, 2)
  currency       String  @default("USD")

  // Source
  sourceType    String // purchased, promotional, refund, manual
  sourceOrderId String?
  sourceOrder   Order?  @relation("GiftCardSource", fields: [sourceOrderId], references: [id], onDelete: SetNull)

  // Recipient info
  recipientEmail  String?
  recipientName   String?
  senderName      String?
  personalMessage String?

  // Delivery
  deliveryMethod String    @default("email") // email, print, physical
  deliveredAt    DateTime?

  // Validity
  activatedAt DateTime?
  expiresAt   DateTime?

  // Status
  status String @default("active") // pending, active, depleted, expired, disabled

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  transactions GiftCardTransaction[]
  payments     Payment[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, status])
  @@map("gift_cards")
}

// Gift card transactions
model GiftCardTransaction {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  giftCardId String
  giftCard   GiftCard @relation(fields: [giftCardId], references: [id], onDelete: Cascade)

  // Transaction details
  type          String // redemption, refund, adjustment, activation
  amount        Decimal @db.Decimal(18, 2) // Negative for redemptions
  balanceBefore Decimal @db.Decimal(18, 2)
  balanceAfter  Decimal @db.Decimal(18, 2)

  // Related order
  orderId String?
  order   Order?  @relation(fields: [orderId], references: [id], onDelete: SetNull)

  // Notes
  notes       String?
  performedBy String?

  createdAt DateTime @default(now())

  @@index([giftCardId])
  @@index([orderId])
  @@map("gift_card_transactions")
}

// Wishlist
model Wishlist {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  customerId String
  customer   StoreCustomer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Wishlist details
  name       String  @default("My Wishlist")
  isDefault  Boolean @default(false)
  isPublic   Boolean @default(false) // For sharing
  shareToken String? @unique // For public sharing URL

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items WishlistItem[]

  @@index([tenantId])
  @@index([customerId])
  @@map("wishlists")
}

// Wishlist Items
model WishlistItem {
  id String @id @default(uuid())

  wishlistId String
  wishlist   Wishlist @relation(fields: [wishlistId], references: [id], onDelete: Cascade)

  productListingId String
  productListing   ProductListing @relation(fields: [productListingId], references: [id], onDelete: Cascade)

  variantId String?
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  // Price at time of adding (for price drop alerts)
  priceWhenAdded Decimal? @db.Decimal(18, 2)

  // Priority/notes
  priority Int     @default(0) // 1=high, 0=normal
  notes    String?

  createdAt DateTime @default(now())

  @@unique([wishlistId, productListingId, variantId])
  @@index([wishlistId])
  @@index([productListingId])
  @@map("wishlist_items")
}

// ==========================================
// Multi-Currency Support
// ==========================================

// Store currency configuration
model StoreCurrency {
  id       String @id @default(uuid())
  tenantId String

  currencyCode       String // ISO 4217 (USD, EUR, GBP)
  symbol             String // $, , 
  symbolPosition     String    @default("before") // before or after
  decimalPlaces      Int       @default(2)
  decimalSeparator   String    @default(".")
  thousandsSeparator String    @default(",")
  exchangeRate       Decimal   @default(1) @db.Decimal(18, 8)
  isBaseCurrency     Boolean   @default(false)
  isEnabled          Boolean   @default(true)
  lastRateUpdate     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, currencyCode])
  @@index([tenantId])
  @@map("store_currencies")
}

// Product price overrides per currency
model ProductPriceOverride {
  id       String @id @default(uuid())
  tenantId String

  productListingId String
  productListing   ProductListing @relation(fields: [productListingId], references: [id], onDelete: Cascade)

  currencyCode   String
  price          Decimal  @db.Decimal(18, 4)
  compareAtPrice Decimal? @db.Decimal(18, 4)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productListingId, currencyCode])
  @@index([tenantId])
  @@map("product_price_overrides")
}

// Variant price overrides per currency
model VariantPriceOverride {
  id       String @id @default(uuid())
  tenantId String

  variantId String
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)

  currencyCode   String
  price          Decimal  @db.Decimal(18, 4)
  compareAtPrice Decimal? @db.Decimal(18, 4)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([variantId, currencyCode])
  @@index([tenantId])
  @@map("variant_price_overrides")
}

// ==========================================
// Shipping System
// ==========================================

// Shipping carriers
model ShippingCarrier {
  id       String @id @default(uuid())
  tenantId String

  name          String // UPS, FedEx, USPS, DHL
  code          String // ups, fedex, usps, dhl
  type          String  @default("api") // api, flat, weight, custom
  isEnabled     Boolean @default(true)
  apiKey        String? // Encrypted
  apiSecret     String? // Encrypted
  accountNumber String?
  testMode      Boolean @default(true)
  settings      Json    @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rates     ShippingRate[]
  shipments Shipment[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@map("shipping_carriers")
}

// Geographic shipping zones
model ShippingZone {
  id       String @id @default(uuid())
  tenantId String

  name      String
  countries String[] @default([])
  states    String[] @default([])
  zipCodes  String[] @default([])
  isDefault Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  rates ShippingRate[]

  @@index([tenantId])
  @@map("shipping_zones")
}

// Shipping rates per zone
model ShippingRate {
  id       String @id @default(uuid())
  tenantId String

  zoneId String
  zone   ShippingZone @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  carrierId String?
  carrier   ShippingCarrier? @relation(fields: [carrierId], references: [id], onDelete: SetNull)

  name                  String
  description           String?
  type                  String   @default("flat") // flat, weight, price, carrier
  price                 Decimal  @default(0) @db.Decimal(18, 4)
  minOrderAmount        Decimal? @db.Decimal(18, 4)
  maxOrderAmount        Decimal? @db.Decimal(18, 4)
  minWeight             Decimal? @db.Decimal(18, 4)
  maxWeight             Decimal? @db.Decimal(18, 4)
  freeShippingThreshold Decimal? @db.Decimal(18, 4)
  estimatedDaysMin      Int?
  estimatedDaysMax      Int?
  carrierServiceCode    String?
  isEnabled             Boolean  @default(true)
  sortOrder             Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  weightTiers  ShippingWeightTier[]
  translations ShippingRateTranslation[]

  @@index([tenantId])
  @@index([zoneId])
  @@map("shipping_rates")
}

// Weight-based pricing tiers
model ShippingWeightTier {
  id       String @id @default(uuid())
  tenantId String

  rateId String
  rate   ShippingRate @relation(fields: [rateId], references: [id], onDelete: Cascade)

  minWeight  Decimal  @default(0) @db.Decimal(18, 4)
  maxWeight  Decimal? @db.Decimal(18, 4)
  price      Decimal  @db.Decimal(18, 4)
  pricePerKg Decimal? @db.Decimal(18, 4)

  createdAt DateTime @default(now())

  @@index([tenantId])
  @@map("shipping_weight_tiers")
}

// Shipment tracking
model Shipment {
  id       String @id @default(uuid())
  tenantId String

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  carrierId String?
  carrier   ShippingCarrier? @relation(fields: [carrierId], references: [id], onDelete: SetNull)

  carrierName       String
  trackingNumber    String?
  trackingUrl       String?
  status            String    @default("pending") // pending, label_created, in_transit, delivered, failed
  labelUrl          String?
  estimatedDelivery DateTime?
  actualDelivery    DateTime?
  shippedAt         DateTime?
  weight            Decimal?  @db.Decimal(18, 4)
  dimensions        Json? // {length, width, height, unit}
  cost              Decimal?  @db.Decimal(18, 4)
  metadata          Json      @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  events ShipmentEvent[]

  @@index([orderId])
  @@index([trackingNumber])
  @@index([tenantId])
  @@map("shipments")
}

// Shipment tracking events
model ShipmentEvent {
  id       String @id @default(uuid())
  tenantId String

  shipmentId String
  shipment   Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  status      String
  description String?
  location    String?
  occurredAt  DateTime
  rawData     Json?

  createdAt DateTime @default(now())

  @@index([shipmentId])
  @@index([tenantId])
  @@map("shipment_events")
}

// ==========================================
// Internationalization (i18n)
// ==========================================

// Store language configuration
model StoreLanguage {
  id       String @id @default(uuid())
  tenantId String

  languageCode String // ISO 639-1 (en, es, fr)
  countryCode  String? // ISO 3166-1 for regional variants
  name         String // "English", "Spanish"
  nativeName   String? // "English", "Espaol"
  isDefault    Boolean @default(false)
  isEnabled    Boolean @default(true)
  sortOrder    Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, languageCode, countryCode])
  @@index([tenantId])
  @@map("store_languages")
}

// Product translations
model ProductTranslation {
  id       String @id @default(uuid())
  tenantId String

  productListingId String
  productListing   ProductListing @relation(fields: [productListingId], references: [id], onDelete: Cascade)

  languageCode     String
  displayName      String
  shortDescription String?
  longDescription  String?
  metaTitle        String?
  metaDescription  String?
  slug             String?
  badge            String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([productListingId, languageCode])
  @@index([tenantId])
  @@index([tenantId, languageCode, slug])
  @@map("product_translations")
}

// Category translations
model CategoryTranslation {
  id       String @id @default(uuid())
  tenantId String

  categoryId String
  category   ProductCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  languageCode    String
  name            String
  description     String?
  slug            String?
  metaTitle       String?
  metaDescription String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([categoryId, languageCode])
  @@index([tenantId])
  @@map("category_translations")
}

// Attribute translations (for attribute types and values)
model AttributeTranslation {
  id       String @id @default(uuid())
  tenantId String

  attributeTypeId String?
  attributeType   ItemAttributeType? @relation(fields: [attributeTypeId], references: [id], onDelete: Cascade)

  attributeValueId String?
  attributeValue   ItemAttributeValue? @relation(fields: [attributeValueId], references: [id], onDelete: Cascade)

  languageCode String
  name         String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@map("attribute_translations")
}

// Shipping rate translations
model ShippingRateTranslation {
  id       String @id @default(uuid())
  tenantId String

  shippingRateId String
  shippingRate   ShippingRate @relation(fields: [shippingRateId], references: [id], onDelete: Cascade)

  languageCode String
  name         String
  description  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([shippingRateId, languageCode])
  @@index([tenantId])
  @@map("shipping_rate_translations")
}

// Static content translations (UI strings, policies)
model ContentTranslation {
  id       String @id @default(uuid())
  tenantId String

  contentKey   String // e.g., "checkout.title", "policy.returns"
  languageCode String
  content      String
  contentType  String @default("text") // text, html, markdown

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, contentKey, languageCode])
  @@index([tenantId, languageCode])
  @@map("content_translations")
}

// ==========================================
// Email Compliance & Preferences
// ==========================================

model StoreCustomerPreferences {
  id         String        @id @default(uuid())
  tenantId   String
  tenant     Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customerId String        @unique
  customer   StoreCustomer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Email preferences
  marketing    Boolean @default(true)
  orderUpdates Boolean @default(true)
  promotions   Boolean @default(true)
  newsletter   Boolean @default(true)

  unsubscribedAt DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@unique([tenantId, customerId])
  @@index([tenantId])
  @@map("store_customer_preferences")
}

model EmailBounce {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  email      String
  type       String // hard_bounce, soft_bounce, complaint, spam
  reason     String?
  bouncedAt  DateTime @default(now())
  suppressed Boolean  @default(false)

  @@index([tenantId, email])
  @@index([suppressed])
  @@index([tenantId, suppressed])
  @@map("email_bounces")
}

// ==================== THEME SYSTEM ====================

model StoreTheme {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Basic Info
  name        String
  slug        String // minimal, bold, classic, modern, custom-1, etc
  description String?
  isActive    Boolean @default(false)
  isCustom    Boolean @default(false)
  isPreset    Boolean @default(false)

  // Color Scheme (JSON for flexibility)
  colors Json // { primary, secondary, accent, background, foreground, etc }

  // Typography
  fontFamily        String  @default("Inter")
  headingFont       String?
  fontSize          String  @default("base") // sm, base, lg
  fontWeightBody    Int     @default(400)
  fontWeightHeading Int     @default(700)

  // Layout Settings
  layoutStyle       String @default("standard") // standard, wide, boxed
  headerStyle       String @default("classic") // classic, minimal, centered
  footerStyle       String @default("standard") // standard, minimal
  spacing           String @default("comfortable") // compact, comfortable, spacious
  containerMaxWidth String @default("1280px")

  // Component Styles
  buttonStyle String @default("rounded") // rounded, square, pill
  buttonSize  String @default("md") // sm, md, lg
  cardStyle   String @default("shadow") // shadow, border, flat
  cardRadius  String @default("lg") // none, sm, md, lg
  inputStyle  String @default("outlined") // outlined, filled

  // Product Display
  productGridColumns Int     @default(3) // 2, 3, 4
  productImageRatio  String  @default("square") // square, portrait, landscape
  showQuickView      Boolean @default(true)
  showWishlist       Boolean @default(true)

  // Advanced
  customCSS  String?
  logoUrl    String?
  faviconUrl String?

  // Metadata
  previewImageUrl String?
  tags            String[] // Array of tags for filtering

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, slug])
  @@index([tenantId, isActive])
  @@index([tenantId, isPreset])
  @@map("store_themes")
}

// ==================== MARKETPLACE INTEGRATIONS ====================

// Marketplace Connection - Each tenant can have multiple eBay/Amazon/etc stores
model MarketplaceConnection {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Connection details
  platform    String // "EBAY", "AMAZON", "ETSY", etc.
  name        String // User-friendly name: "Main eBay Store", "Clearance Store"
  description String?

  // OAuth Tokens (encrypted)
  refreshToken      String?
  accessToken       String?
  accessTokenExpiry DateTime?

  // Platform-specific configuration (JSON)
  platformConfig Json @default("{}")

  // eBay-specific fields
  marketplaceId String? // EBAY_US, EBAY_UK, EBAY_DE
  siteId        Int?

  // Business Policies (fetched during OAuth)
  fulfillmentPolicyId String?
  paymentPolicyId     String?
  returnPolicyId      String?

  // Inventory Location
  locationKey String?

  // Status
  isActive    Boolean @default(true)
  isConnected Boolean @default(false)
  isDefault   Boolean @default(false)

  // Sync settings
  autoSyncInventory Boolean @default(true)
  autoSyncOrders    Boolean @default(true)
  lastSyncAt        DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  listings       MarketplaceListing[]
  orders         MarketplaceOrder[]
  syncLogs       MarketplaceSyncLog[]
  activeListings MarketplaceActiveListing[]

  @@unique([tenantId, platform, name])
  @@index([tenantId, platform])
  @@index([tenantId, isActive])
  @@map("marketplace_connections")
}

// Marketplace Listing - Links NoSlag products to eBay/Amazon listings
model MarketplaceListing {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Connection
  connectionId String
  connection   MarketplaceConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  // Link to NoSlag product
  productListingId String
  productListing   ProductListing @relation(fields: [productListingId], references: [id], onDelete: Cascade)

  // Optional: Link to specific warehouse for this listing
  warehouseId String?
  warehouse   Warehouse? @relation(fields: [warehouseId], references: [id], onDelete: SetNull)

  // Platform identifiers
  externalOfferId   String? @unique // eBay offer ID, Amazon ASIN, etc.
  externalListingId String? @unique // Published listing ID
  externalItemId    String?
  sku               String // SKU used on platform (may differ from productListing)

  // Listing details (snapshot at time of listing)
  title       String
  description String
  price       Decimal @db.Decimal(18, 2)
  quantity    Int
  condition   String
  categoryId  String

  // Platform-specific fields (JSON)
  platformData Json @default("{}")

  // Photos (JSON array)
  photos Json @default("[]")

  // Item Specifics (JSON)
  itemSpecifics Json?

  // Package details
  packageType     String?
  weightValue     Decimal? @db.Decimal(18, 4)
  weightUnit      String?
  dimensionLength Decimal? @db.Decimal(18, 4)
  dimensionWidth  Decimal? @db.Decimal(18, 4)
  dimensionHeight Decimal? @db.Decimal(18, 4)
  dimensionUnit   String?

  // Policies (can override connection defaults)
  fulfillmentPolicyId String?
  paymentPolicyId     String?
  returnPolicyId      String?

  // Status
  status       String // draft, pending_approval, approved, publishing, published, ended, error
  syncStatus   String @default("pending") // synced, pending, error
  errorMessage String?

  // Workflow
  approvedById    String?
  approvedBy      User?     @relation("MarketplaceListingApprover", fields: [approvedById], references: [id], onDelete: SetNull)
  approvedAt      DateTime?
  rejectedById    String?
  rejectedBy      User?     @relation("MarketplaceListingRejecter", fields: [rejectedById], references: [id], onDelete: SetNull)
  rejectedAt      DateTime?
  rejectionReason String?

  // Platform payloads (for debugging)
  inventoryItemPayload Json?
  offerPayload         Json?
  publishResult        Json?

  // Dates
  publishedAt DateTime?
  endedAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([connectionId, productListingId])
  @@unique([connectionId, sku])
  @@index([tenantId, status])
  @@index([connectionId])
  @@index([productListingId])
  @@index([externalListingId])
  @@map("marketplace_listings")
}

// Active Listings - Synced from marketplace (read-only mirror)
model MarketplaceActiveListing {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  connectionId String
  connection   MarketplaceConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  // Platform IDs
  externalListingId String @unique
  externalItemId    String?
  sku               String

  // Basic info
  title        String
  currentPrice Decimal @db.Decimal(18, 2)
  currency     String  @default("USD")

  // Inventory
  quantityAvailable Int
  quantitySold      Int @default(0)

  // Metrics
  watchCount Int @default(0)
  viewCount  Int @default(0)

  // Status
  status String // ACTIVE, ENDED, OUT_OF_STOCK

  // Dates
  startTime DateTime
  endTime   DateTime?

  // Links
  viewItemUrl String?
  categoryId  String

  // Sync
  lastSyncedAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([tenantId, connectionId])
  @@index([connectionId, status])
  @@index([sku])
  @@map("marketplace_active_listings")
}

// Marketplace Order - Platform orders synced to NoSlag
model MarketplaceOrder {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  connectionId String
  connection   MarketplaceConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  // Link to NoSlag order (created after sync)
  orderId String? @unique
  order   Order?  @relation(fields: [orderId], references: [id], onDelete: SetNull)

  // Platform identifiers
  externalOrderId String @unique

  // Buyer info
  buyerUsername String
  buyerEmail    String?

  // Shipping address
  shippingName       String
  shippingStreet1    String
  shippingStreet2    String?
  shippingCity       String
  shippingState      String?
  shippingPostalCode String
  shippingCountry    String

  // Financial
  subtotal     Decimal @db.Decimal(18, 2)
  shippingCost Decimal @db.Decimal(18, 2)
  taxAmount    Decimal @db.Decimal(18, 2)
  total        Decimal @db.Decimal(18, 2)
  currency     String  @default("USD")

  // Status
  externalStatus    String // Platform's status
  paymentStatus     String
  fulfillmentStatus String @default("NOT_STARTED")

  // Dates
  orderDate   DateTime
  paymentDate DateTime?

  // Sync status
  syncStatus      String    @default("pending") // synced, pending, error
  syncedToOrderAt DateTime?
  errorMessage    String?

  // Items (JSON array - will be normalized to Order  OrderItem)
  itemsData Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, connectionId])
  @@index([connectionId, syncStatus])
  @@index([externalOrderId])
  @@map("marketplace_orders")
}

// Sync Logs - Track all sync operations
model MarketplaceSyncLog {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  connectionId String
  connection   MarketplaceConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  syncType  String // inventory_sync, order_sync, listing_sync
  direction String // to_marketplace, from_marketplace, bidirectional

  status       String // success, partial, failed
  itemsTotal   Int    @default(0)
  itemsSuccess Int    @default(0)
  itemsFailed  Int    @default(0)

  details      String? // Summary message
  errorMessage String?
  metadata     Json? // Detailed info

  startedAt   DateTime @default(now())
  completedAt DateTime?

  @@index([tenantId, connectionId])
  @@index([syncType, status])
  @@map("marketplace_sync_logs")
}

// Failed Operations - Track operations that failed and need retry
model FailedOperation {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  operationType OperationType
  status        OperationStatus @default(PENDING)

  // Reference to the entity this operation is for (e.g., orderId, paymentId)
  referenceId   String
  referenceType String // order, payment, webhook, etc.

  // Operation payload (e.g., stock deduction items, coupon code, email data)
  payload Json

  // Error tracking
  errorMessage String?
  errorStack   String?

  // Retry tracking
  attemptCount  Int       @default(0)
  maxAttempts   Int       @default(3)
  nextRetryAt   DateTime?
  lastAttemptAt DateTime?
  succeededAt   DateTime?
  failedAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, status])
  @@index([nextRetryAt])
  @@index([referenceId, referenceType])
  @@map("failed_operations")
}

enum OperationType {
  STOCK_DEDUCTION
  COUPON_TRACKING
  EMAIL_SEND
  WEBHOOK_DELIVERY
}

enum OperationStatus {
  PENDING
  RETRYING
  FAILED
  SUCCEEDED
}

//  Webhook System (Database-Backed) 

model Webhook {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name    String
  url     String
  events  String[]
  secret  String
  headers Json     @default("{}")
  status  String   @default("active") // active, paused, disabled

  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  deliveries WebhookDelivery[]

  @@index([tenantId, status])
  @@map("webhooks")
}

model WebhookDelivery {
  id        String  @id @default(uuid())
  webhookId String
  webhook   Webhook @relation(fields: [webhookId], references: [id], onDelete: Cascade)

  event      String
  payload    String   @db.Text
  statusCode Int      @default(0)
  response   String?  @db.Text
  error      String?  @db.Text
  duration   Int      @default(0)
  success    Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@index([webhookId, createdAt])
  @@map("webhook_deliveries")
}

//  Processed Webhook Events (Stripe Deduplication) 

model ProcessedWebhookEvent {
  id          String   @id @default(uuid())
  eventId     String   @unique
  eventType   String
  processedAt DateTime @default(now())

  @@index([eventId])
  @@map("processed_webhook_events")
}

//  OAuth State Management 

model OAuthState {
  id           String   @id
  connectionId String
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  @@index([expiresAt])
  @@map("oauth_states")
}

//  Merchant Email Verification 

model MerchantEmailVerificationToken {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@map("merchant_email_verification_tokens")
}

//  Store Pages (Legal, Custom) 

model StorePage {
  id          String  @id @default(uuid())
  tenantId    String
  tenant      Tenant  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  slug        String
  title       String
  content     String  @db.Text
  isPublished Boolean @default(true)

  sections PageSection[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@map("store_pages")
}

//  Product Import Jobs 

model ProductImportJob {
  id            String    @id @default(uuid())
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  fileName      String
  status        String    @default("pending") // pending, processing, completed, failed
  totalRows     Int       @default(0)
  processedRows Int       @default(0)
  successCount  Int       @default(0)
  errorCount    Int       @default(0)
  errors        Json      @default("[]")
  startedAt     DateTime?
  completedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@map("product_import_jobs")
}

// ==================== PAGE BUILDER ====================

model PageSection {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  pageId String
  page   StorePage @relation(fields: [pageId], references: [id], onDelete: Cascade)

  type     String // hero, features, products, testimonials, cta, text, image, gallery, newsletter, faq, banner
  config   Json   @default("{}") // Section-specific configuration
  position Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([pageId])
  @@index([tenantId])
  @@map("page_sections")
}

// ==================== DIGITAL PRODUCTS ====================

model DigitalDownload {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  orderId   String
  order     Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String
  product   ProductListing @relation(fields: [productId], references: [id], onDelete: Cascade)

  downloadCount Int       @default(0)
  maxDownloads  Int?
  expiresAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([tenantId])
  @@map("digital_downloads")
}

// ==================== FUNNEL ANALYTICS ====================

model FunnelEvent {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  sessionId  String
  customerId String?
  eventType  String  // page_view, product_view, add_to_cart, begin_checkout, purchase
  productId  String?
  metadata   Json    @default("{}")
  utmSource  String?
  utmMedium  String?
  utmCampaign String?
  referrer   String?

  createdAt DateTime @default(now())

  @@index([tenantId, eventType])
  @@index([tenantId, sessionId])
  @@index([tenantId, createdAt])
  @@map("funnel_events")
}

// ==================== SCHEDULED REPORTS ====================

model ScheduledReport {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  reportType String     // sales_summary, inventory_snapshot, customer_activity, order_fulfillment
  schedule   String     // cron expression
  recipients String[]   // Email addresses
  format     String     @default("csv") // csv, pdf, xlsx
  isActive   Boolean    @default(true)
  lastRunAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@map("scheduled_reports")
}
