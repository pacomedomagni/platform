generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

enum StockConsumptionStrategy {
  FIFO
  FEFO
}

model Tenant {
  id                       String                   @id @default(uuid())
  name                     String
  businessName             String?                  // Display name for storefront
  email                    String?                  // Contact/support email
  domain                   String?                  @unique
  isActive                 Boolean                  @default(true)
  baseCurrency             String                   @default("USD")
  stockConsumptionStrategy StockConsumptionStrategy @default(FIFO)
  allowNegativeStock       Boolean                  @default(false)
  createdAt                DateTime                 @default(now())
  updatedAt                DateTime                 @updatedAt

  users                 User[]
  warehouses            Warehouse[]
  locations             Location[]
  items                 Item[]
  itemUoms              ItemUom[]
  batches               Batch[]
  serials               Serial[]
  warehouseItemBalances WarehouseItemBalance[]
  binBalances           BinBalance[]
  stockFifoLayers       StockFifoLayer[]
  stockPostings         StockPosting[]
  stockLedgerEntries    StockLedgerEntry[]
  stockLedgerEntrySerials StockLedgerEntrySerial[]
  accounts              Account[]
  glEntries             GlEntry[]
  auditLogs             AuditLog[]
  customers             Customer[]
  suppliers             Supplier[]
  addresses             Address[]
  contacts              Contact[]
  contactLinks          ContactLink[]
  banks                 Bank[]
  bankAccounts          BankAccount[]
  bankTransactions      BankTransaction[]
  bankReconciliations   BankReconciliation[]
  bankReconciliationDetails BankReconciliationDetail[]
  bankMatchingRules     BankMatchingRule[]
  
  // Storefront relations
  productCategories     ProductCategory[]
  productListings       ProductListing[]
  storeCustomers        StoreCustomer[]
  storeAddresses        StoreAddress[]
  passwordResets        PasswordReset[]
  carts                 Cart[]
  cartItems             CartItem[]
  orders                Order[]
  orderItems            OrderItem[]
  payments              Payment[]
  coupons               Coupon[]

  @@map("tenants")
}

model User {
  id        String  @id @default(uuid())
  email     String  @unique
  password  String  @default("") // Managed by Auth Provider usually, but here for completeness
  firstName String?
  lastName  String?

  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  roles String[] @default(["user"])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Index for performance
  @@index([tenantId])
  @@map("users")
}

model Currency {
  code      String   @id // ISO 4217, e.g. "USD"
  name      String
  symbol    String?
  decimals  Int      @default(2)
  isEnabled Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("currencies")
}

model ExchangeRate {
  id        String   @id @default(uuid())
  fromCode  String
  toCode    String
  rate      Decimal  @db.Decimal(18, 9)
  rateDate  DateTime @db.Date
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([fromCode, toCode, rateDate])
  @@index([toCode, rateDate])
  @@map("exchange_rates")
}

model DocType {
  id          String  @id @default(uuid())
  name        String  @unique // Internal ID name, e.g. "Sales Order"
  module      String // e.g. "Selling"
  isSingle    Boolean @default(false)
  isChild     Boolean @default(false)
  description String?

  fields DocField[]
  perms  DocPerm[]

  // For storing the table name if it differs, though usually derived from name
  tableName String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("doc_types")
}

model DocField {
  id String @id @default(uuid())

  docTypeName String
  docType     DocType @relation(fields: [docTypeName], references: [name], onDelete: Cascade)

  name  String // e.g. "customer"
  label String // e.g. "Customer"
  type  String // Data, Link, Int, etc.

  required Boolean @default(false)
  unique   Boolean @default(false)
  hidden   Boolean @default(false)
  readonly Boolean @default(false)

  options String? // For Select
  target  String? // For Link (related DocType name)

  idx Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([docTypeName])
  @@map("doc_fields")
}

model DocPerm {
  id String @id @default(uuid())

  docTypeName String
  docType     DocType @relation(fields: [docTypeName], references: [name], onDelete: Cascade)

  role String // e.g. "System Manager", "Sales User"

  read   Boolean @default(true)
  write  Boolean @default(false)
  create Boolean @default(false)
  delete Boolean @default(false)
  submit Boolean @default(false)
  cancel Boolean @default(false)
  amend  Boolean @default(false)
  report Boolean @default(false)

  idx Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([docTypeName])
  @@index([role])
  @@map("doc_perms")
}

model Warehouse {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  code     String
  name     String
  isActive Boolean @default(true)

  // Optional defaults for operational flows
  defaultReceivingLocationId String?
  defaultPickingLocationId   String?

  locations Location[]

  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  warehouseItemBalances WarehouseItemBalance[]
  binBalances           BinBalance[]
  stockFifoLayers       StockFifoLayer[]
  stockLedgerEntries    StockLedgerEntry[]
  serials               Serial[]

  @@unique([tenantId, code])
  @@unique([tenantId, name])
  @@map("warehouses")
}

model Location {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  parentId String?
  parent   Location?  @relation("LocationTree", fields: [parentId], references: [id], onDelete: SetNull)
  children Location[] @relation("LocationTree")

  code String
  name String?
  path String // e.g. "WH1/A1/BIN-01"

  isPickable Boolean @default(true)
  isPutaway  Boolean @default(true)
  isStaging  Boolean @default(false)
  isActive   Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stockFromEntries StockLedgerEntry[] @relation("StockFromLocation")
  stockToEntries   StockLedgerEntry[] @relation("StockToLocation")
  binBalances      BinBalance[]
  stockFifoLayers  StockFifoLayer[]
  serials          Serial[]

  @@unique([tenantId, warehouseId, code])
  @@unique([tenantId, warehouseId, path])
  @@index([warehouseId])
  @@map("locations")
}

model Item {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  code        String
  name        String
  isStockItem Boolean @default(true)
  isActive    Boolean @default(true)

  hasBatch  Boolean @default(false)
  hasSerial Boolean @default(false)
  reorderLevel Decimal? @db.Decimal(18, 6)
  reorderQty   Decimal? @db.Decimal(18, 6)

  incomeAccount  String?
  expenseAccount String?
  stockAccount   String?
  cogsAccount    String?

  stockUomCode    String?
  stockUom        Uom?     @relation("ItemStockUom", fields: [stockUomCode], references: [code], onDelete: SetNull)
  purchaseUomCode String?
  purchaseUom     Uom?     @relation("ItemPurchaseUom", fields: [purchaseUomCode], references: [code], onDelete: SetNull)
  salesUomCode    String?
  salesUom        Uom?     @relation("ItemSalesUom", fields: [salesUomCode], references: [code], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  batches               Batch[]
  serials               Serial[]
  itemUoms              ItemUom[]
  warehouseItemBalances WarehouseItemBalance[]
  binBalances           BinBalance[]
  stockFifoLayers       StockFifoLayer[]
  stockLedgerEntries    StockLedgerEntry[]
  productListing        ProductListing?

  @@unique([tenantId, code])
  @@map("items")
}

model Uom {
  code     String @id
  name     String?
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  itemsStock    Item[]    @relation("ItemStockUom")
  itemsPurchase Item[]    @relation("ItemPurchaseUom")
  itemsSales    Item[]    @relation("ItemSalesUom")
  itemUoms      ItemUom[]

  @@map("uoms")
}

model ItemUom {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  itemId String
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Cascade)

  uomCode String
  uom     Uom    @relation(fields: [uomCode], references: [code], onDelete: Cascade)

  conversionFactor Decimal @db.Decimal(18, 6)
  isActive         Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, itemId, uomCode])
  @@index([itemId])
  @@map("item_uoms")
}

enum SerialStatus {
  AVAILABLE
  ISSUED
}

model Serial {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  itemId String
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Cascade)

  serialNo String
  status   SerialStatus @default(AVAILABLE)

  warehouseId String?
  warehouse   Warehouse? @relation(fields: [warehouseId], references: [id], onDelete: SetNull)

  locationId String?
  location   Location? @relation(fields: [locationId], references: [id], onDelete: SetNull)

  batchId String?
  batch   Batch?  @relation(fields: [batchId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ledgerEntries StockLedgerEntrySerial[]

  @@unique([tenantId, serialNo])
  @@index([itemId])
  @@index([warehouseId])
  @@map("serials")
}

model Batch {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  itemId String
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Cascade)

  batchNo  String
  mfgDate  DateTime? @db.Date
  expDate  DateTime? @db.Date
  isActive Boolean   @default(true)

  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  binBalances        BinBalance[]
  stockFifoLayers    StockFifoLayer[]
  stockLedgerEntries StockLedgerEntry[]
  serials            Serial[]

  @@unique([tenantId, itemId, batchNo])
  @@index([itemId])
  @@map("batches")
}

model WarehouseItemBalance {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  itemId String
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Cascade)

  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  actualQty   Decimal @default(0) @db.Decimal(18, 6)
  reservedQty Decimal @default(0) @db.Decimal(18, 6)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, itemId, warehouseId])
  @@index([warehouseId])
  @@map("warehouse_item_balances")
}

model BinBalance {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  itemId String
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Cascade)

  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  locationId String
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  batchId String?
  batch   Batch?  @relation(fields: [batchId], references: [id], onDelete: SetNull)

  actualQty Decimal @default(0) @db.Decimal(18, 6)
  reservedQty Decimal @default(0) @db.Decimal(18, 6)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, itemId, warehouseId, locationId, batchId])
  @@index([locationId])
  @@map("bin_balances")
}

model StockFifoLayer {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  itemId String
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Cascade)

  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  locationId String
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)

  batchId String?
  batch   Batch?  @relation(fields: [batchId], references: [id], onDelete: SetNull)

  postingTs    DateTime
  qtyOriginal  Decimal  @db.Decimal(18, 6)
  qtyRemaining Decimal  @db.Decimal(18, 6)
  incomingRate Decimal  @db.Decimal(18, 6)
  isCancelled  Boolean  @default(false)

  // For derived layers (e.g. stock transfer), keep lineage to support safe reversals.
  sourceLayerId String?
  sourceLayer   StockFifoLayer? @relation("LayerSource", fields: [sourceLayerId], references: [id], onDelete: SetNull)
  derivedLayers StockFifoLayer[] @relation("LayerSource")

  voucherType String
  voucherNo   String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  stockLedgerEntries StockLedgerEntry[]

  @@index([tenantId, itemId, warehouseId, postingTs])
  @@index([batchId])
  @@index([sourceLayerId])
  @@map("stock_fifo_layers")
}

model StockPosting {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  postingKey  String
  voucherType String
  voucherNo   String

  createdAt DateTime @default(now())

  @@unique([tenantId, postingKey])
  @@index([tenantId, voucherType, voucherNo])
  @@map("stock_postings")
}

model AuditLog {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  userId  String?
  action  String
  docType String
  docName String
  meta    Json?

  createdAt DateTime @default(now())

  @@index([tenantId, docType])
  @@index([docName])
  @@map("audit_logs")
}

model StockLedgerEntry {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  postingTs   DateTime
  postingDate DateTime @db.Date

  itemId String
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Cascade)

  warehouseId String
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  fromLocationId String?
  fromLocation   Location? @relation("StockFromLocation", fields: [fromLocationId], references: [id], onDelete: SetNull)
  toLocationId   String?
  toLocation     Location? @relation("StockToLocation", fields: [toLocationId], references: [id], onDelete: SetNull)

  batchId String?
  batch   Batch?  @relation(fields: [batchId], references: [id], onDelete: SetNull)

  fifoLayerId String?
  fifoLayer   StockFifoLayer? @relation(fields: [fifoLayerId], references: [id], onDelete: SetNull)

  qty                  Decimal @db.Decimal(18, 6)
  valuationRate        Decimal @db.Decimal(18, 6)
  stockValueDifference Decimal @db.Decimal(18, 6)

  voucherType String
  voucherNo   String

  createdAt DateTime @default(now())

  serials StockLedgerEntrySerial[]

  @@index([tenantId, postingDate])
  @@index([tenantId, itemId, warehouseId])
  @@index([tenantId, voucherType, voucherNo])
  @@map("stock_ledger_entries")
}

model StockLedgerEntrySerial {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  ledgerEntryId String
  ledgerEntry   StockLedgerEntry @relation(fields: [ledgerEntryId], references: [id], onDelete: Cascade)

  serialId String
  serial   Serial @relation(fields: [serialId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([ledgerEntryId])
  @@index([serialId])
  @@map("stock_ledger_entry_serials")
}

model Account {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  code     String
  name     String
  rootType    String?
  accountType String?
  isGroup     Boolean @default(false)
  parentAccountCode String?
  currency String? // null means tenant base currency
  isActive Boolean @default(true)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  glEntries GlEntry[]

  @@unique([tenantId, code])
  @@map("accounts")
}

model GlEntry {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  postingDate DateTime @db.Date
  postingTs   DateTime

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  currency     String
  exchangeRate Decimal @db.Decimal(18, 9)

  debitBc  Decimal @default(0) @db.Decimal(18, 6)
  creditBc Decimal @default(0) @db.Decimal(18, 6)
  debitFc  Decimal @default(0) @db.Decimal(18, 6)
  creditFc Decimal @default(0) @db.Decimal(18, 6)

  voucherType String
  voucherNo   String
  remarks     String?

  createdAt DateTime @default(now())

  @@index([tenantId, postingDate])
  @@index([tenantId, voucherType, voucherNo])
  @@map("gl_entries")
}

// ==================== PARTY MASTERS ====================

model Customer {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  code          String
  customerName  String
  customerType  String  @default("Company")
  customerGroup String?
  territory     String?

  taxId       String?
  taxCategory String?

  defaultCurrency     String?
  defaultPriceList    String?
  defaultPaymentTerms String?

  creditLimit Decimal @default(0) @db.Decimal(18, 6)
  creditDays  Int     @default(0)

  receivableAccount String?

  primaryAddress String?
  primaryContact String?

  isActive Boolean @default(true)
  isFrozen Boolean @default(false)

  website String?
  notes   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  storeCustomers StoreCustomer[]

  @@unique([tenantId, code])
  @@index([tenantId, customerName])
  @@index([tenantId, customerGroup])
  @@map("customers")
}

model Supplier {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  code          String
  supplierName  String
  supplierType  String  @default("Company")
  supplierGroup String?
  country       String?

  taxId                   String?
  taxCategory             String?
  taxWithholdingCategory  String?

  defaultCurrency     String?
  defaultPriceList    String?
  defaultPaymentTerms String?

  paymentDays Int @default(0)

  payableAccount String?
  expenseAccount String?

  primaryAddress String?
  primaryContact String?

  isActive Boolean @default(true)
  isFrozen Boolean @default(false)

  website String?
  notes   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, code])
  @@index([tenantId, supplierName])
  @@index([tenantId, supplierGroup])
  @@map("suppliers")
}

model Address {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  linkDoctype String
  linkName    String

  addressType  String  @default("Billing")
  addressTitle String?
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  country      String  @default("United States")
  postalCode   String?

  phone String?
  fax   String?
  email String?

  isPrimaryAddress  Boolean @default(false)
  isShippingAddress Boolean @default(false)
  isActive          Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, linkDoctype, linkName])
  @@map("addresses")
}

model Contact {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String
  firstName   String?
  lastName    String?
  fullName    String?
  salutation  String?
  designation String?

  email  String?
  phone  String?
  mobile String?

  isPrimaryContact Boolean @default(false)
  isBillingContact Boolean @default(false)
  isActive         Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  links ContactLink[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("contacts")
}

model ContactLink {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  contactId String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  linkDoctype String
  linkName    String

  createdAt DateTime @default(now())

  @@unique([tenantId, contactId, linkDoctype, linkName])
  @@index([contactId])
  @@index([tenantId, linkDoctype, linkName])
  @@map("contact_links")
}

// ==================== BANKING ====================

model Bank {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  code     String
  bankName String

  website   String?
  swiftCode String?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, code])
  @@index([tenantId])
  @@map("banks")
}

model BankAccount {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name String

  bankCode      String?
  accountNumber String?
  accountType   String  @default("Current")
  iban          String?
  branchCode    String?

  glAccount String?
  currency  String  @default("USD")

  bankBalance  Decimal   @default(0) @db.Decimal(18, 6)
  lastSyncDate DateTime? @db.Date

  integrationId String?

  isDefault Boolean @default(false)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([tenantId, glAccount])
  @@map("bank_accounts")
}

model BankTransaction {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name String

  bankAccount     String
  transactionDate DateTime @db.Date
  amount          Decimal  @db.Decimal(18, 6)
  currency        String   @default("USD")
  transactionType String

  description     String?
  referenceNumber String?

  partyType String?
  party     String?

  status String @default("Unreconciled")

  paymentEntry String?
  invoice      String?

  reconciliationId String?

  importBatch String?
  externalId  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([tenantId, bankAccount])
  @@index([tenantId, transactionDate])
  @@index([tenantId, status])
  @@index([tenantId, externalId])
  @@map("bank_transactions")
}

model BankReconciliation {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name String

  bankAccount String

  fromDate DateTime @db.Date
  toDate   DateTime @db.Date

  openingBalance       Decimal @default(0) @db.Decimal(18, 6)
  closingBalance       Decimal @default(0) @db.Decimal(18, 6)
  bankStatementBalance Decimal @default(0) @db.Decimal(18, 6)

  difference Decimal @default(0) @db.Decimal(18, 6)

  docstatus Int    @default(0)
  status    String @default("Draft")

  notes String?
  owner String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  details BankReconciliationDetail[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([tenantId, bankAccount])
  @@map("bank_reconciliations")
}

model BankReconciliationDetail {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  parentId String
  parent   BankReconciliation @relation(fields: [parentId], references: [id], onDelete: Cascade)

  bankTransaction String?
  glEntryId       String?

  voucherType String?
  voucherNo   String?

  amount      Decimal   @db.Decimal(18, 6)
  postingDate DateTime? @db.Date

  isMatched     Boolean   @default(false)
  clearanceDate DateTime? @db.Date

  createdAt DateTime @default(now())

  @@index([parentId])
  @@index([tenantId])
  @@map("bank_reconciliation_details")
}

model BankMatchingRule {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name String

  bankAccount         String?
  descriptionContains String?
  descriptionRegex    String?
  amountMin           Decimal? @db.Decimal(18, 6)
  amountMax           Decimal? @db.Decimal(18, 6)
  transactionType     String?

  action    String  @default("Create Payment Entry")
  partyType String?
  party     String?
  account   String?

  priority Int @default(0)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("bank_matching_rules")
}

// ==================== STOREFRONT ====================

model ProductCategory {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name        String
  slug        String
  description String?
  imageUrl    String?

  parentId String?
  parent   ProductCategory?  @relation("CategoryTree", fields: [parentId], references: [id], onDelete: SetNull)
  children ProductCategory[] @relation("CategoryTree")

  sortOrder Int     @default(0)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products ProductListing[]

  @@unique([tenantId, slug])
  @@index([tenantId, isActive])
  @@map("product_categories")
}

model ProductListing {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  itemId String @unique
  item   Item   @relation(fields: [itemId], references: [id], onDelete: Cascade)

  categoryId String?
  category   ProductCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  slug             String
  displayName      String
  shortDescription String?
  longDescription  String?

  price         Decimal  @db.Decimal(18, 2)
  compareAtPrice Decimal? @db.Decimal(18, 2)
  costPrice      Decimal? @db.Decimal(18, 2)

  images     String[] // Array of image URLs
  badge      String?  // "Best Seller", "New Arrival", "Limited", etc.
  
  metaTitle       String?
  metaDescription String?
  
  isFeatured    Boolean @default(false)
  isPublished   Boolean @default(false)
  publishedAt   DateTime?

  sortOrder Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  cartItems     CartItem[]
  orderItems    OrderItem[]

  @@unique([tenantId, slug])
  @@unique([tenantId, itemId])
  @@index([tenantId, isPublished])
  @@index([tenantId, categoryId])
  @@index([tenantId, isFeatured])
  @@map("product_listings")
}

// Storefront Customer (separate from B2B Customer)
model StoreCustomer {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  email         String
  passwordHash  String?
  firstName     String?
  lastName      String?
  phone         String?

  // Link to B2B customer record if applicable
  customerId String?
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  // Email verification
  emailVerified   Boolean   @default(false)
  emailVerifiedAt DateTime?

  // Password reset
  resetToken      String?
  resetTokenExp   DateTime?

  // Marketing preferences
  acceptsMarketing Boolean @default(false)

  lastLoginAt DateTime?
  isActive    Boolean   @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  carts           Cart[]
  orders          Order[]
  addresses       StoreAddress[]
  passwordResets  PasswordReset[]

  @@unique([tenantId, email])
  @@index([tenantId, isActive])
  @@map("store_customers")
}

model StoreAddress {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  customerId String
  customer   StoreCustomer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  label        String  @default("Home")
  firstName    String?
  lastName     String?
  company      String?
  addressLine1 String
  addressLine2 String?
  city         String
  state        String?
  postalCode   String
  country      String  @default("US")
  phone        String?

  isDefault Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([customerId])
  @@map("store_addresses")
}

model PasswordReset {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  customerId String
  customer   StoreCustomer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?

  createdAt DateTime @default(now())

  @@index([customerId])
  @@index([token])
  @@map("password_resets")
}

model Cart {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Can be anonymous (no customer) or linked to customer
  customerId String?
  customer   StoreCustomer? @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // Anonymous cart token
  sessionToken String? @unique

  // Cart status
  status String @default("active") // active, converted, abandoned

  // Shipping address (snapshot at checkout)
  shippingAddressId String?

  // Coupon/discount
  couponCode String?
  discountAmount Decimal @default(0) @db.Decimal(18, 2)

  // Calculated totals (updated on cart changes)
  subtotal      Decimal @default(0) @db.Decimal(18, 2)
  shippingTotal Decimal @default(0) @db.Decimal(18, 2)
  taxTotal      Decimal @default(0) @db.Decimal(18, 2)
  grandTotal    Decimal @default(0) @db.Decimal(18, 2)

  // Cart recovery
  abandonedAt   DateTime?
  recoveredAt   DateTime?
  lastActivityAt DateTime @default(now())

  expiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items CartItem[]
  order Order?

  @@index([tenantId, customerId])
  @@index([tenantId, sessionToken])
  @@index([tenantId, status])
  @@map("carts")
}

model CartItem {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  cartId String
  cart   Cart   @relation(fields: [cartId], references: [id], onDelete: Cascade)

  productId String
  product   ProductListing @relation(fields: [productId], references: [id], onDelete: Cascade)

  quantity Int     @default(1)
  price    Decimal @db.Decimal(18, 2) // Price at time of adding to cart

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cartId, productId])
  @@index([cartId])
  @@map("cart_items")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

model Order {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  orderNumber String

  customerId String?
  customer   StoreCustomer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  // Link to original cart
  cartId String? @unique
  cart   Cart?   @relation(fields: [cartId], references: [id], onDelete: SetNull)

  // Contact info (may differ from customer)
  email String
  phone String?

  // Billing address (snapshot)
  billingFirstName    String?
  billingLastName     String?
  billingCompany      String?
  billingAddressLine1 String?
  billingAddressLine2 String?
  billingCity         String?
  billingState        String?
  billingPostalCode   String?
  billingCountry      String?

  // Shipping address (snapshot)
  shippingFirstName    String?
  shippingLastName     String?
  shippingCompany      String?
  shippingAddressLine1 String?
  shippingAddressLine2 String?
  shippingCity         String?
  shippingState        String?
  shippingPostalCode   String?
  shippingCountry      String?

  // Order totals
  subtotal       Decimal @db.Decimal(18, 2)
  shippingTotal  Decimal @db.Decimal(18, 2)
  taxTotal       Decimal @db.Decimal(18, 2)
  discountTotal  Decimal @default(0) @db.Decimal(18, 2)
  grandTotal     Decimal @db.Decimal(18, 2)

  currency String @default("USD")

  // Status tracking
  status        OrderStatus   @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)

  // Stripe integration
  stripePaymentIntentId String?
  stripeChargeId        String?

  // Shipping tracking
  shippingMethod   String?
  shippingCarrier  String?
  trackingNumber   String?
  shippedAt        DateTime?
  deliveredAt      DateTime?

  // Notes
  customerNotes String?
  internalNotes String?

  // Timestamps
  confirmedAt DateTime?
  cancelledAt DateTime?
  refundedAt  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  items    OrderItem[]
  payments Payment[]

  @@unique([tenantId, orderNumber])
  @@index([tenantId, customerId])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@index([stripePaymentIntentId])
  @@map("orders")
}

model OrderItem {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String?
  product   ProductListing? @relation(fields: [productId], references: [id], onDelete: SetNull)

  // Snapshot of product at time of order
  sku         String?
  name        String
  description String?
  imageUrl    String?

  quantity   Int
  unitPrice  Decimal @db.Decimal(18, 2)
  totalPrice Decimal @db.Decimal(18, 2)

  // Fulfillment tracking
  quantityFulfilled Int @default(0)
  quantityRefunded  Int @default(0)

  createdAt DateTime @default(now())

  @@index([orderId])
  @@map("order_items")
}

model Payment {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  orderId String
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Payment details
  amount   Decimal @db.Decimal(18, 2)
  currency String  @default("USD")
  method   String  @default("card") // card, paypal, bank_transfer, etc.

  // Status
  status PaymentStatus @default(PENDING)

  // Stripe references
  stripePaymentIntentId String?
  stripeChargeId        String?
  stripeRefundId        String?

  // Card details (last 4 digits only for display)
  cardBrand   String?
  cardLast4   String?
  cardExpiry  String?

  // Error tracking
  errorCode    String?
  errorMessage String?

  // Timestamps
  authorizedAt DateTime?
  capturedAt   DateTime?
  failedAt     DateTime?
  refundedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([stripePaymentIntentId])
  @@map("payments")
}

// Coupon/discount codes
model Coupon {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  code        String
  description String?

  // Discount type
  discountType String  @default("percentage") // percentage, fixed_amount
  discountValue Decimal @db.Decimal(18, 2)

  // Constraints
  minimumOrderAmount Decimal? @db.Decimal(18, 2)
  maximumDiscount    Decimal? @db.Decimal(18, 2)

  // Usage limits
  usageLimit     Int? // Total times this coupon can be used
  usageLimitPerCustomer Int? @default(1)
  timesUsed      Int  @default(0)

  // Validity
  startsAt  DateTime?
  expiresAt DateTime?

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, code])
  @@index([tenantId, isActive])
  @@map("coupons")
}
